include:
  ################
  # DrupalCI includes:
  # As long as you include this, any future includes added by the Drupal Association will be accessible to your pipelines automatically.
  # View these include files at https://git.drupalcode.org/project/gitlab_templates/
  ################
  - project: $_GITLAB_TEMPLATES_REPO
    ref: $_GITLAB_TEMPLATES_REF
    file:
      - '/includes/include.drupalci.main-d7.yml'
      - '/includes/include.drupalci.variables.yml'
      - '/includes/include.drupalci.workflows.yml'

variables:
  _SHOW_ENVIRONMENT_VARIABLES: 1
  OPT_IN_TEST_MAX_PHP: 1

# -------------------------------- BUILD ---------------------------------------

.skip-and-opt-in-debug: &skip-and-opt-in-debug
  - |
    echo " "
    echo "SKIP_PHPCS=$SKIP_PHPCS" $([[ $SKIP_PHPCS != 0 ]] && echo "(not default)")
    echo "SKIP_PHPUNIT=$SKIP_PHPUNIT" $([[ $SKIP_PHPUNIT != 0 ]] && echo "(not default)")
    echo "SKIP_TEST_ONLY_CHANGES=$SKIP_TEST_ONLY_CHANGES" $([[ $SKIP_TEST_ONLY_CHANGES != 0 ]] && echo "(not default)")
    echo " "
    echo "_GITLAB_TEMPLATES_REPO = $_GITLAB_TEMPLATES_REPO"
    echo "_CURL_TEMPLATES_REPO   = $_CURL_TEMPLATES_REPO"
    echo "_GITLAB_TEMPLATES_REF  = $_GITLAB_TEMPLATES_REF"
    echo "_CURL_TEMPLATES_REF    = $_CURL_TEMPLATES_REF"

.composer-base:
  after_script:
    - *skip-and-opt-in-debug
    # Show the last three commits. Current directory /builds/project/scheduler ($CI_PROJECT_DIR) is correct.
    - pwd
    - git show -3 --stat
    # Third-party modules loaded via the projects composer.json will be in
    # vendor/drupal but they need to be moved into sites/all/modules.
    # The 'drupal' and 'coder' directories must not be moved.
    # @todo Remove this when https://www.drupal.org/project/gitlab_templates/issues/3480296 is complete.
    - ls $CI_PROJECT_DIR/vendor/drupal | grep -Ev '(drupal|coder)' | xargs -I {} mv -v $CI_PROJECT_DIR/vendor/drupal/{} $CI_PROJECT_DIR/$_WEB_ROOT/sites/all/modules || true
    # Give confirmation of the directories in vendor/drupal and sites/all/modules.
    - ls $CI_PROJECT_DIR/vendor/drupal
    - ls $CI_PROJECT_DIR/$_WEB_ROOT/sites/all/modules

# -------------------------------- VALIDATE ------------------------------------

phpcs:
  allow_failure: false

# -------------------------------- TEST ----------------------------------------

.scheduler-matrix: &scheduler-matrix
  parallel:
    matrix:
      # Run test classes in parallel.
      - _MATRIX_VALUE:
        - SchedulerFunctionalTest
        - SchedulerDateModuleTest
        - SchedulerRulesTest
        - SchedulerApiTestCase

.scheduler-phpunit-rule: &scheduler-phpunit-rule
  - variables:
      # Specify parameters that will be passed to RUN-TESTS.SH
      _PHPUNIT_EXTRA: --class $_MATRIX_VALUE $_PHPUNIT_PARAMETERS

phpunit:
  <<: *scheduler-matrix
  rules:
    - !reference [ .skip-phpunit-rule ]
    - *scheduler-phpunit-rule
    - when: on_success
  after_script:
    - pwd
    - printf "_PHPUNIT_EXTRA=$_PHPUNIT_EXTRA\n_MATRIX_VALUE=$_MATRIX_VALUE\n_PHPUNIT_PARAMETERS=$_PHPUNIT_PARAMETERS"
